# Инструкция по релизу новой версии

## Версионирование

Используется следующая схема версионирования - <upstream_version>-CROC<X>. Где X - инкрементируется с каждым новым релизом. Например при текущей версии апстрима v0.5.0 и текущей версии этой репы v0.5.0-CROC1 следующая версия будет v0.5.0-CROC2. При обновлении версии апстрима, например до v0.6.0, успешный ребейз на новый апстрим будет результирован в версию v0.6.0-CROC2. Предполагается суппорт только актуальных версий.

Версии обозначаются гит тегами. Тегируется мастер ветка используя механизм релизов гитхаба. При создании нового релиза, описание релиза заполняется краткой сводкой изменений в новом релизе. После создания нового релиза (и тега), тег забирается на локалку (git pull upstream master --tags) и выполняется ручная сборка и публикация артефактов.

## Пререквизиты

В системе должны быть установлены следующие компоненты:
- `awk`
- `sed` (для macOS потребуется дополнительно установить `gnu-sed`)
- [`kustomize`](https://github.com/kubernetes-sigs/kustomize)

## Подготовка

Перед началом сборки артефактов необходимо обновить версию приложения в переменной `VERSION` в `Makefile`

Выполнить make-target retag-sidecar-images (опционально, при изменении версий sidecar-образов).
Данный скрипт сделает pull образов из GCR, tag и pull на наши репозитории.
```
make retag-sidecar-images
```
По-умолчанию он выполнит push в репозиторий, указанный в переменной `REGISTRY` в `Makefile`.
Переопределить это можно, указав список registry в переменной окружения `RELEASE_REGISTRIES` через пробел.

Для обновления версий и репозиториев sidecar-образов в kustomize-оверлее c2, необходимо выполнить:
```
make generate-c2-kustomize
```

## Артефакты

Релизными артефактами этой репы является докер имадж и deployment конфиги для kubernetes. При любом новом релизе необходимо обновлять kustomization.yaml и генерить бандл:
- используя утилиту `kustomize` собрать сингл-yaml-файл бандл для деплоймента:
```
kustomize build ./deploy/kubernetes/overlays/stable/c2 > ./deploy/kubernetes/overlays/stable/с2/k_bundle.yaml
```
### Сборка образа
Для создания докер имаджа необходимы установленный и настроенный докер демон - https://docs.docker.com/get-docker/. Для сборки имаджа необходимо:
- Установить переменную окружения `RELEASE_REGISTRIES` со значением в виде списка репозиториев в формате `<registry-1> <registry-2> ...`
- находясь в руте репы выполнить:
  ```
  make release-image
  ```
Данный таргет соберет релизный контейнер и зальет его в реджистри

### Сбока образа для тестов
Для создания образа для запуска тестов `aws-ebs-csi-driver-e2e-tester` необходимо выполнить последовательно две команды:
```
make test-image
make publish-test-image
```
