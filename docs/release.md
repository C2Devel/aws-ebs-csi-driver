# Инструкция по релизу новой версии

## Версионирование

Используется следующая схема версионирования - <upstream_version>-CROC<X>. Где X - инкрементируется с каждым новым релизом. Например при текущей версии апстрима v0.5.0 и текущей версии этой репы v0.5.0-CROC1 следующая версия будет v0.5.0-CROC2. При обновлении версии апстрима, например до v0.6.0, успешный ребейз на новый апстрим будет результирован в версию v0.6.0-CROC2. Предполагается суппорт только актуальных версий.

Версии обозначаются гит тегами. Тегируется мастер ветка используя механизм релизов гитхаба. При создании нового релиза, описание релиза заполняется краткой сводкой изменений в новом релизе. После создания нового релиза (и тега), тег забирается на локалку (git pull upstream master --tags) и выполняется ручная сборка и публикация артефактов.

## Пререквизиты

В системе должны быть установлены следующие компоненты:
- `awk`
- `sed` (для macOS потребуется дополнительно установить `gnu-sed`)
- [`kustomize`](https://github.com/kubernetes-sigs/kustomize)

## Подготовка

Перед началом сборки артефактов необходимо обновить версию приложения в переменной `VERSION` в `Makefile`

Выполнить hack-скрипт retag-sidecar-images (опционально, при изменении версий sidecar-образов).
Данный скрипт обновит версии и репозиторий sidecar-образов в kustomize-оверлее c2, сделает pull образов из GCR, tag и pull на наш репозиторий
```
make retag-sidecar-images
```
Если же необходимо только обновить версии контейнеров, то нужно выполнить скрипт с флагом -v (--versions-only):
```
make retag-sidecar-images ARGS="-v"
```


## Артефакты

Релизными артефактами этой репы является докер имадж и deployment конфиги для kubernetes. При любом новом релизе необходимо обновлять kustomization.yaml и генерить бандл:
- используя утилиту `kustomize` собрать сингл-yaml-файл бандл для деплоймента:
```
kustomize build ./deploy/kubernetes/overlays/stable/c2 > ./deploy/kubernetes/overlays/stable/k_bundle.yaml
```
### Сборка образа
Для создания докер имаджа необходимы установленный и настроенный докер демон - https://docs.docker.com/get-docker/ . Для сборки имаджа необходимо находясь в руте репы выполнить:
```
make release-image
```
Данный таргет соберет релизный контейнер и зальет его в реджистри